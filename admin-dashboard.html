<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACADEMIX PRO | Full Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); --glass: rgba(255, 255, 255, 0.1); --text: #f8fafc; }
        * { box-sizing: border-box; transition: 0.3s; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        
        .top-bar { backdrop-filter: blur(20px); background: rgba(139, 0, 0, 0.3); padding: 15px 30px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass); }
        .container { padding: 25px; max-width: 1300px; margin: auto; }
        .grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 25px; border-radius: 24px; border: 1px solid var(--glass); margin-bottom: 20px; }
        .req-card { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 18px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; background: rgba(0,0,0,0.4); border: 1px solid var(--glass); border-radius: 12px; color: white; }
        button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        button:hover { background: var(--accent); transform: translateY(-2px); }

        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; }
        .fab-main { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(255, 62, 62, 0.4); z-index: 1001; position: relative; }
        .fab-options { position: absolute; bottom: 80px; right: 0; display: none; flex-direction: column; gap: 12px; }
        .fab-container.active .fab-options { display: flex; }
        .fab-item { background: white; color: black; padding: 12px 25px; border-radius: 30px; font-size: 14px; font-weight: 800; white-space: nowrap; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 2000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 30px; width: 100%; max-width: 500px; border: 1px solid var(--accent); position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; opacity: 0.5; }
        
        .tab-btn { padding: 10px; background: none; border: none; border-bottom: 2px solid transparent; flex: 1; color: var(--text); cursor: pointer; }
        .tab-btn.active { border-color: var(--accent); color: var(--accent); font-weight: 700; }
        
        .dynamic-row { display: flex; gap: 8px; margin-bottom: 5px; }
        .admin-list-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-top: 5px; display: flex; justify-content: space-between; }
        
        /* New Pipeline Actions Styling */
        .pipeline-actions { display: flex; gap: 5px; }
        .btn-small { padding: 8px 12px; font-size: 11px; }
        .btn-reject { background: #475569; }
        .btn-pdf { background: #10b981; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="logo">ACADEMIX <span style="color:var(--accent)">PRO</span></div>
    <div id="adminDisplay">...</div>
    <button onclick="logout()" style="background:rgba(255,255,255,0.1)">Logout</button>
</div>

<div class="container">
    <div class="grid">
        <div class="main-panel">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Admission Pipeline</h2>
                    <span id="countLabel" style="background:#10b981; padding:5px 12px; border-radius:20px; font-size:12px">0 NEW</span>
                </div>
                <div id="requestList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div style="display:flex; margin-bottom:20px; border-bottom:1px solid var(--glass);">
                    <button class="tab-btn active" id="detailsTab" onclick="switchTab('details')">Profile</button>
                    <button class="tab-btn" id="resultsTab" onclick="switchTab('results')">Results</button>
                </div>
                <input id="finderInput" placeholder="Enrollment ID">
                <button id="finderBtn" style="width:100%" onclick="mainSearch()">üîç Run Search</button>
                <div id="finderResult" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="fab-container" id="fabMenu">
    <div class="fab-options">
        <div class="fab-item" onclick="openAdminManager()">üîë Manage Admins</div>
        <div class="fab-item" onclick="openStudentModal()">üë§ Direct Student Entry</div>
        <div class="fab-item" onclick="openResultModal()">üìä Enter Exam Result</div>
    </div>
    <div class="fab-main" onclick="toggleFab()">+</div>
</div>

<div class="modal" id="systemModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">√ó</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const activeId = localStorage.getItem("activeAdminId");
    const activeName = localStorage.getItem("activeAdminName");
    if(!activeId) window.location.href = "login.html";
    document.getElementById("adminDisplay").innerText = "Admin: " + activeName;

    function toggleFab() { document.getElementById('fabMenu').classList.toggle('active'); }
    function closeModal() { document.getElementById('systemModal').classList.remove('active'); }

    // --- Student Entry Form (Modified to handle Auto-fill) ---
async function openStudentModal(prefillData = null, reqDocId = null) {
        if(!prefillData) toggleFab();
        
        const snap = await db.collection("students").get();
        let max = 0; snap.forEach(s => { if(parseInt(s.id) > max) max = parseInt(s.id); });
        const nextID = (max + 1).toString().padStart(4, '0');

        let classValue = "1";
        if(prefillData && prefillData.class) {
            classValue = prefillData.class.replace(/\D/g,'') || "1";
        }

        // Identify extra fields like image/photo that are not in the main inputs
        let extraFieldsHtml = '';
        if(prefillData) {
            const standardKeys = ['name', 'father', 'class', 'mobile'];
            Object.entries(prefillData).forEach(([key, value]) => {
                if(!standardKeys.includes(key) && value) {
                    extraFieldsHtml += `
                        <div class="dynamic-row">
                            <input value="${key}" class="ext-key">
                            <input value="${value}" class="ext-val">
                        </div>`;
                }
            });
        }

        document.getElementById('modalBody').innerHTML = `
            <h3>${prefillData ? 'Approve' : 'Add New'} Student</h3>
            <input id="s_id" value="${nextID}" placeholder="Enrollment ID">
            <input id="s_name" value="${prefillData ? prefillData.name : ''}" placeholder="Full Name">
            <input id="s_father" value="${prefillData ? (prefillData.father || '') : ''}" placeholder="Father's Name">
            <select id="s_class">
                <option value="PG" ${classValue=="PG"?'selected':''}>PG</option>
                <option value="LKG" ${classValue=="LKG"?'selected':''}>LKG</option>
                <option value="UKG" ${classValue=="UKG"?'selected':''}>UKG</option>
                <option value="1" ${classValue=="1"?'selected':''}>Class 1st</option>
                <option value="2" ${classValue=="2"?'selected':''}>Class 2nd</option>
                <option value="3" ${classValue=="3"?'selected':''}>Class 3rd</option>
                <option value="4" ${classValue=="4"?'selected':''}>Class 4rth</option>
                <option value="5" ${classValue=="5"?'selected':''}>Class 5th</option>
                <option value="6" ${classValue=="6"?'selected':''}>Class 6th</option>
                <option value="7" ${classValue=="7"?'selected':''}>Class 7th</option>
                <option value="8" ${classValue=="8"?'selected':''}>Class 8th</option>
            </select>
            <input id="s_mobile" value="${prefillData ? (prefillData.mobile || '') : ''}" placeholder="Mobile Number">
            <div id="extraFields">
                ${extraFieldsHtml}
            </div>
            <button onclick="addExtraField()" style="background:#334155; width:100%; margin:10px 0; font-size:12px">+ Add More Detail</button>
            <button onclick="saveStudent('${reqDocId}')" style="width:100%">Confirm & Save</button>`;
        document.getElementById('systemModal').classList.add('active');
    }
        document.getElementById('modalBody').innerHTML = `
            <h3>${prefillData ? 'Approve' : 'Add New'} Student</h3>
            <input id="s_id" value="${nextID}" placeholder="Enrollment ID">
            <input id="s_name" value="${prefillData ? prefillData.name : ''}" placeholder="Full Name">
            <input id="s_father" value="${prefillData ? (prefillData.father || '') : ''}" placeholder="Father's Name">
            <select id="s_class">
                <option value="1" ${classValue=="1"?'selected':''}>Class 1</option>
                <option value="2" ${classValue=="2"?'selected':''}>Class 2</option>
                <option value="9" ${classValue=="9"?'selected':''}>Class 9</option>
                <option value="10" ${classValue=="10"?'selected':''}>Class 10</option>
            </select>
            <input id="s_mobile" value="${prefillData ? (prefillData.mobile || '') : ''}" placeholder="Mobile Number">
            <div id="extraFields">
                ${prefillData && prefillData.address ? `<div class="dynamic-row"><input value="Address" class="ext-key"><input value="${prefillData.address}" class="ext-val"></div>` : ''}
            </div>
            <button onclick="addExtraField()" style="background:#334155; width:100%; margin:10px 0; font-size:12px">+ Add More Detail</button>
            <button onclick="saveStudent('${reqDocId}')" style="width:100%">Confirm & Save</button>`;
        document.getElementById('systemModal').classList.add('active');
    }

    function addExtraField() {
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        div.innerHTML = `<input placeholder="Label" class="ext-key"><input placeholder="Value" class="ext-val">`;
        document.getElementById('extraFields').appendChild(div);
    }

    async function saveStudent(reqDocId = "null") {
        const data = {
            id: document.getElementById('s_id').value,
            name: document.getElementById('s_name').value,
            father: document.getElementById('s_father').value,
            class: document.getElementById('s_class').value,
            mobile: document.getElementById('s_mobile').value
        };

        const keys = document.querySelectorAll('.ext-key');
        const vals = document.querySelectorAll('.ext-val');
        keys.forEach((k, i) => { if(k.value) data[k.value] = vals[i].value; });

        await db.collection("students").doc(data.id).set(data);
        
        // Clean up: If this was from a request, delete the request
        if(reqDocId !== "null" && reqDocId !== "undefined") {
            await db.collection("new_requests").doc(reqDocId).delete();
        }

        alert("Student Successfully Registered!"); closeModal();
    }

    // --- Admin Management ---
    async function openAdminManager() {
        toggleFab();
        document.getElementById('modalBody').innerHTML = `
            <h3>Manage Admins</h3>
            <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-bottom:20px;">
                <input id="newAdminName" placeholder="Admin Name">
                <input id="newAdminId" placeholder="Login ID">
                <input id="newAdminPass" type="password" placeholder="Password">
                <button onclick="addNewAdmin()" style="width:100%">Add Admin Access</button>
            </div>
            <div id="adminListContainer">Loading admins...</div>`;
        document.getElementById('systemModal').classList.add('active');
        loadAdminList();
    }

    async function loadAdminList() {
        const snap = await db.collection("admins").get();
        let html = "<h4>Current Admins</h4>";
        snap.forEach(doc => {
            html += `<div class="admin-list-item">
                <span><b>${doc.data().name}</b> (${doc.id})</span>
                <button onclick="deleteAdmin('${doc.id}')" style="padding:5px 10px; background:#ef4444; font-size:10px">Remove</button>
            </div>`;
        });
        document.getElementById("adminListContainer").innerHTML = html;
    }

    async function addNewAdmin() {
        const id = document.getElementById("newAdminId").value;
        const name = document.getElementById("newAdminName").value;
        const pass = document.getElementById("newAdminPass").value;
        if(!id || !name || !pass) return alert("Fill all fields");
        await db.collection("admins").doc(id).set({ name: name, password: pass });
        loadAdminList();
    }

    async function deleteAdmin(id) {
        if(confirm("Remove this admin?")) {
            await db.collection("admins").doc(id).delete();
            loadAdminList();
        }
    }

    // --- Result Logic ---
    function openResultModal() {
        toggleFab();
        document.getElementById('modalBody').innerHTML = `
            <h3>Enter Marks</h3>
            <input id="r_id" placeholder="Student ID (e.g. 0001)">
            <input id="r_exam" placeholder="Exam Name">
            <div id="subjectList"><div style="display:flex; gap:5px"><input placeholder="Subject" class="sub-name"><input placeholder="Marks" class="sub-marks" style="width:80px"></div></div>
            <button onclick="addSubjectRow()" style="background:#334155; width:100%; margin:10px 0">+ Add Subject</button>
            <button onclick="saveResult()" style="width:100%">Upload Result</button>`;
        document.getElementById('systemModal').classList.add('active');
    }

    function addSubjectRow() {
        const div = document.createElement('div'); div.style.display = 'flex'; div.style.gap = '5px';
        div.innerHTML = `<input placeholder="Subject" class="sub-name"><input placeholder="Marks" class="sub-marks" style="width:80px">`;
        document.getElementById('subjectList').appendChild(div);
    }

    async function saveResult() {
        const sid = document.getElementById('r_id').value;
        const examName = document.getElementById('r_exam').value;
        const names = document.querySelectorAll('.sub-name');
        const marks = document.querySelectorAll('.sub-marks');
        let subjects = {};
        names.forEach((n, i) => { if(n.value) subjects[n.value] = marks[i].value; });
        const docRef = db.collection("results").doc(sid);
        const doc = await docRef.get();
        let data = doc.exists ? doc.data() : { exams: {} };
        data.exams[examName] = { subjects: subjects, date: new Date().toLocaleDateString() };
        await docRef.set(data);
        alert("Result Uploaded!"); closeModal();
    }

    // --- Pipeline Stream (With Reject & PDF Fix) ---
    db.collection("new_requests").onSnapshot(snap => {
        let html = "";
        document.getElementById("countLabel").innerText = snap.size + " NEW";
        snap.forEach(doc => {
            const d = doc.data();
            html += `<div class="req-card">
                <div><b>${d.name}</b><br><small>${d.class} | ${d.mobile}</small></div>
                <div class="pipeline-actions">
                    <button class="btn-small btn-pdf" onclick='generatePDF(${JSON.stringify(d)}, "REGISTRATION SLIP")'>üìÑ</button>
                    <button class="btn-small" onclick='approveAdmission("${doc.id}")'>Accept</button>
                    <button class="btn-small btn-reject" onclick='rejectAdmission("${doc.id}")'>√ó</button>
                </div>
            </div>`;
        });
        document.getElementById("requestList").innerHTML = html || "No requests";
    });

    async function approveAdmission(reqId) {
        const doc = await db.collection("new_requests").doc(reqId).get();
        if(doc.exists) {
            openStudentModal(doc.data(), reqId);
        }
    }

    async function rejectAdmission(reqId) {
        if(confirm("Are you sure you want to reject and delete this request?")) {
            await db.collection("new_requests").doc(reqId).delete();
        }
    }

    // --- Existing Utility ---
    let currentMode = 'details';
    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('detailsTab').classList.toggle('active', mode==='details');
        document.getElementById('resultsTab').classList.toggle('active', mode==='results');
    }

    async function mainSearch() {
        const id = document.getElementById("finderInput").value;
        const resDiv = document.getElementById("finderResult");
        if(currentMode === 'details') {
            const doc = await db.collection("students").doc(id).get();
            if(doc.exists) {
                const d = doc.data();
                resDiv.innerHTML = `<div class="card" style="background:rgba(16,185,129,0.1)"><h4>${d.name}</h4><p>Class: ${d.class}</p><button onclick='generatePDF(${JSON.stringify(d)}, "PROFILE")'>PDF</button></div>`;
            } else resDiv.innerHTML = "Not Found";
        } else {
            const doc = await db.collection("results").doc(id).get();
            if(doc.exists) {
                let html = "<h4>Exams Found:</h4>";
                Object.keys(doc.data().exams).forEach(ex => { html += `<button onclick="downloadResult('${id}','${ex}')" style="width:100%; margin-bottom:5px">${ex}</button>`; });
                resDiv.innerHTML = html;
            } else resDiv.innerHTML = "No Results";
        }
    }

    async function downloadResult(sid, exId) {
        const s = (await db.collection("students").doc(sid).get()).data();
        const r = (await db.collection("results").doc(sid).get()).data().exams[exId];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Report: ${exId}`, 20, 20);
        doc.text(`Student: ${s.name}`, 20, 30);
        doc.autoTable({ startY: 40, head: [['Subject', 'Marks']], body: Object.entries(r.subjects) });
        doc.save(`${s.name}_result.pdf`);
    }
function generatePDF(data, title) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont("helvetica", "bold");
        doc.text("JANTRAJI DEVI VIDYA MANDIR LAMBHUA", 105, 15, {align: "center"});
        doc.setFontSize(10);
        doc.text(title, 105, 22, {align: "center"});

        // Separate image URL if exists and filter it out from the table data
        let imageUrl = null;
        const tableBody = [];

        Object.entries(data).forEach(([key, value]) => {
            if (typeof value === 'string' && (value.startsWith('http') || value.startsWith('data:image'))) {
                imageUrl = value; // Store image link
            } else {
                tableBody.push([key.toUpperCase(), value]);
            }
        });

        // Add Table
        doc.autoTable({ 
            startY: 30, 
            body: tableBody, 
            theme: 'grid',
            margin: { right: imageUrl ? 60 : 15 } // Make space for image if it exists
        });

        // If image exists, add it to the top right of the table area
        if (imageUrl) {
            try {
                doc.addImage(imageUrl, 'JPEG', 155, 30, 40, 40);
            } catch (e) {
                console.error("Image loading failed", e);
                doc.text("Image failed to load", 155, 35);
            }
        }

        doc.save(`${data.name || 'record'}.pdf`);
    }
    function logout() { localStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>






