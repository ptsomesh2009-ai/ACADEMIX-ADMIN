<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACADEMIX PRO | Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); --glass: rgba(255, 255, 255, 0.1); --text: #f8fafc; }
        * { box-sizing: border-box; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Layout */
        .top-bar { backdrop-filter: blur(20px); background: rgba(139, 0, 0, 0.3); padding: 15px 30px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass); }
        .container { padding: 25px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Cards */
        .card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 20px; border-radius: 20px; border: 1px solid var(--glass); margin-bottom: 20px; }
        .req-card { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-top: 12px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* UI Elements */
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border: 1px solid var(--glass); border-radius: 10px; color: white; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
        button:hover { background: var(--accent); transform: translateY(-2px); }
        .btn-row { display: flex; gap: 10px; margin-top: 12px; }

        /* FAB Plus System */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; display: flex; flex-direction: column; align-items: center; }
        .main-fab { width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .mini-fab { width: 45px; height: 45px; background: var(--text); color: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; cursor: pointer; opacity: 0; transform: translateY(20px); pointer-events: none; font-size: 20px; }
        .fab-container.active .mini-fab { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-container.active .main-fab { transform: rotate(45deg); background: #334155; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; border: 1px solid var(--accent); text-align: center; }

        .admin-options { display: none; margin-top: 15px; border-top: 1px solid var(--glass); padding-top: 15px; }
        .show { display: block; }
    </style>
</head>
<body>

<div class="top-bar">
    <h2 style="margin:0; font-size: 1.2rem;">ACADEMIX <span style="color:var(--accent)">PRO</span></h2>
    <div id="adminDisplay" style="font-size: 0.9rem; opacity: 0.8;">Admin Loading...</div>
</div>

<div class="container">
    <div class="grid">
        <div class="card" style="grid-column: span 2;">
            <h3 style="margin:0; color:var(--accent);">NEW ADMISSIONS</h3>
            <div id="requestList" style="margin-top:15px;">Scanning database...</div>
        </div>

        <div>
            <div class="card">
                <h3>MANAGE ADMIN</h3>
                <button onclick="document.getElementById('adminOptions').classList.toggle('show')" style="background:#334155;">üõ°Ô∏è Settings</button>
                <div class="admin-options" id="adminOptions">
                    <input id="up_name" placeholder="New Display Name">
                    <input id="up_key" placeholder="New Security Key">
                    <button onclick="triggerAuth('update')">Update Profile</button>
                    <hr style="opacity:0.1; margin:15px 0;">
                    <input id="add_name" placeholder="Staff Name">
                    <input id="add_id" placeholder="Staff ID (admin2)">
                    <input id="add_key" placeholder="Assign Key">
                    <button onclick="triggerAuth('add')" style="background:#444;">Add Staff</button>
                </div>
            </div>
            
            <div class="card">
                <h3>STUDENT FINDER</h3>
                <input id="enrollSearch" placeholder="Enter Enrollment ID">
                <button onclick="findStudent()">üîç Search</button>
                <div id="searchResult" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="systemModal">
    <div class="modal-content" id="modalContent">
        </div>
</div>

<div class="fab-container" id="fabMenu">
    <div class="mini-fab" onclick="window.location.href='student-results.html'">üìä</div>
    <div class="mini-fab" onclick="window.location.href='student-entry.html'">üë§</div>
    <div class="main-fab" onclick="document.getElementById('fabMenu').classList.toggle('active')">+</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentTask = null;

    // --- REALTIME REQUESTS ---
    db.collection("new_requests").onSnapshot(snap => {
        let html = "";
        snap.forEach(doc => {
            const d = doc.data();
            html += `<div class="req-card">
                <b>${d.name}</b> <small>(Class ${d.class})</small><br>
                <span style="font-size:12px; opacity:0.6;">Father: ${d.father} | Mob: ${d.mobile}</span>
                <div class="btn-row">
                    <button style="background:#10b981" onclick="openEnroll('${doc.id}', '${d.name}')">ACCEPT</button>
                    <button style="background:#ef4444; flex:0.4;" onclick="rejectReq('${doc.id}')">REJECT</button>
                </div>
            </div>`;
        });
        document.getElementById("requestList").innerHTML = html || "No pending requests.";
    });

    // --- ENROLLMENT LOGIC ---
    async function openEnroll(id, name) {
        currentTask = { type: 'enroll', id: id, name: name };
        const students = await db.collection("students").get();
        let max = 0;
        students.forEach(s => { if(parseInt(s.id) > max) max = parseInt(s.id); });
        const nextID = (max + 1).toString().padStart(4, '0');

        document.getElementById("modalContent").innerHTML = `
            <h3>Assign Enrollment</h3>
            <p>Student: <b>${name}</b></p>
            <input id="finalID" value="${nextID}" style="text-align:center; font-size:22px; color:var(--accent);">
            <div class="btn-row">
                <button onclick="closeModal()" style="background:#444">Cancel</button>
                <button onclick="processEnrollment()">Confirm Admission</button>
            </div>`;
        document.getElementById("systemModal").classList.add("active");
    }

    async function processEnrollment() {
        const id = document.getElementById("finalID").value;
        const snap = await db.collection("new_requests").doc(currentTask.id).get();
        const d = snap.data();

        await db.collection("students").doc(id).set({
            name: d.name, class: d.class, parent: d.father, school: "jdvm", year: "2026-27"
        });
        await db.collection("new_requests").doc(currentTask.id).delete();
        alert("Student Enrolled!"); closeModal();
    }

    // --- ADMIN SECURITY LOGIC ---
    function triggerAuth(action) {
        currentTask = { type: action };
        document.getElementById("modalContent").innerHTML = `
            <h3>Security Check</h3>
            <p>Enter your <b>Security Key</b> to continue.</p>
            <input type="password" id="authKey" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; letter-spacing:5px;">
            <div class="btn-row">
                <button onclick="closeModal()" style="background:#444">Cancel</button>
                <button onclick="verifyAndExecute()">Verify</button>
            </div>`;
        document.getElementById("systemModal").classList.add("active");
    }

    async function verifyAndExecute() {
        const keyInput = document.getElementById("authKey").value;
        const adminDoc = await db.collection("admins").doc("admin1").get();
        
        if(keyInput === adminDoc.data().key) {
            if(currentTask.type === 'update') {
                await db.collection("admins").doc("admin1").update({
                    name: document.getElementById("up_name").value,
                    key: document.getElementById("up_key").value
                });
            } else if(currentTask.type === 'add') {
                await db.collection("admins").doc(document.getElementById("add_id").value).set({
                    name: document.getElementById("add_name").value,
                    key: document.getElementById("add_key").value
                });
            }
            alert("Action Successful!"); location.reload();
        } else { alert("Invalid Key!"); }
    }

    // --- UTILITIES ---
    async function rejectReq(id) { if(confirm("Reject this?")) await db.collection("new_requests").doc(id).delete(); }
    function closeModal() { document.getElementById("systemModal").classList.remove("active"); }
    function findStudent() {
        const id = document.getElementById("enrollSearch").value;
        db.collection("students").doc(id).get().then(doc => {
            const res = document.getElementById("searchResult");
            res.innerHTML = doc.exists ? `<span style="color:#10b981">Found: ${doc.data().name}</span>` : `<span style="color:#ef4444">Not Found</span>`;
        });
    }
    db.collection("admins").doc("admin1").onSnapshot(d => { if(d.exists) document.getElementById("adminDisplay").innerText = "Welcome, " + d.data().name; });
</script>

</body>
</html>
