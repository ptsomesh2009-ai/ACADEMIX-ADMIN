<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACADEMIX PRO | Master Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); --glass: rgba(255, 255, 255, 0.1); --text: #f8fafc; }
        * { box-sizing: border-box; transition: 0.3s; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        .top-bar { backdrop-filter: blur(20px); background: rgba(139, 0, 0, 0.3); padding: 15px 30px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass); }
        .container { padding: 25px; max-width: 1300px; margin: auto; }
        .grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 25px; border-radius: 24px; border: 1px solid var(--glass); margin-bottom: 20px; }
        .req-card { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 18px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        
        input { width: 100%; padding: 14px; margin: 10px 0; background: rgba(0,0,0,0.4); border: 1px solid var(--glass); border-radius: 12px; color: white; }
        button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        button:hover { background: var(--accent); transform: translateY(-2px); }

        /* FAB Plus Icon - Click Logic */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; }
        .fab-main { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(255, 62, 62, 0.4); transform: rotate(0deg); }
        .fab-container.active .fab-main { transform: rotate(45deg); background: #334155; }
        
        .fab-options { position: absolute; bottom: 80px; right: 0; display: none; flex-direction: column; gap: 12px; pointer-events: none; opacity: 0; transform: translateY(20px); transition: 0.3s; }
        .fab-container.active .fab-options { display: flex; pointer-events: auto; opacity: 1; transform: translateY(0); }
        
        .fab-item { background: white; color: black; padding: 12px 25px; border-radius: 30px; font-size: 14px; font-weight: 800; white-space: nowrap; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: right; }
        .fab-item:hover { background: var(--accent); color: white; }

        .tab-btn { padding: 10px; background: none; border: none; border-bottom: 2px solid transparent; flex: 1; color: var(--text); cursor: pointer; }
        .tab-btn.active { border-color: var(--accent); color: var(--accent); font-weight: 700; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 35px; border-radius: 30px; width: 95%; max-width: 450px; border: 1px solid var(--accent); }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="logo">ACADEMIX <span style="color:var(--accent)">PRO</span></div>
    <div id="adminDisplay">Loading...</div>
    <button onclick="logout()" style="background:rgba(255,255,255,0.1)">Logout</button>
</div>

<div class="container">
    <div class="grid">
        <div class="main-panel">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Admission Pipeline</h2>
                    <span id="countLabel" style="background:#10b981; padding:5px 12px; border-radius:20px; font-size:12px">0 NEW</span>
                </div>
                <div id="requestList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div style="display:flex; margin-bottom:20px; border-bottom:1px solid var(--glass);">
                    <button class="tab-btn active" id="detailsTab" onclick="switchTab('details')">Profile</button>
                    <button class="tab-btn" id="resultsTab" onclick="switchTab('results')">Results</button>
                </div>
                <input id="finderInput" placeholder="Enrollment ID (e.g. 0002)">
                <button id="finderBtn" style="width:100%" onclick="mainSearch()">üîç Run Search</button>
                <div id="finderResult" style="margin-top:20px;"></div>
            </div>

            <div class="card">
                <h3>Admin Config</h3>
                <input id="up_name" placeholder="Name">
                <input id="up_key" type="password" placeholder="Security Key">
                <button onclick="triggerUpdate()" style="width:100%">Update Profile</button>
            </div>
        </div>
    </div>
</div>

<div class="fab-container" id="fabMenu">
    <div class="fab-options">
        <div class="fab-item" onclick="alert('Student form coming soon')">üë§ Add New Student</div>
        <div class="fab-item" onclick="alert('Result entry coming soon')">üìä Enter Exam Result</div>
    </div>
    <div class="fab-main" onclick="toggleFab()">+</div>
</div>

<div class="modal" id="systemModal">
    <div class="modal-content" id="modalContent"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const activeId = localStorage.getItem("activeAdminId");
    const activeName = localStorage.getItem("activeAdminName");
    if(!activeId) window.location.href = "login.html";
    document.getElementById("adminDisplay").innerText = "Admin: " + activeName;

    // --- FAB Toggle Logic ---
    function toggleFab() {
        document.getElementById('fabMenu').classList.toggle('active');
    }

    // Close FAB if clicked outside
    window.onclick = function(event) {
        if (!event.target.closest('#fabMenu')) {
            document.getElementById('fabMenu').classList.remove('active');
        }
    }

    let currentMode = 'details';
    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('detailsTab').classList.toggle('active', mode==='details');
        document.getElementById('resultsTab').classList.toggle('active', mode==='results');
        document.getElementById('finderResult').innerHTML = "";
    }

    // --- Dynamic Search ---
    async function mainSearch() {
        const id = document.getElementById("finderInput").value;
        const resDiv = document.getElementById("finderResult");
        if(!id) return;

        if(currentMode === 'details') {
            const doc = await db.collection("students").doc(id).get();
            if(doc.exists) {
                const d = doc.data();
                resDiv.innerHTML = `
                <div style="border-left:4px solid #10b981; padding:15px; background:rgba(255,255,255,0.02); border-radius:0 15px 15px 0">
                    <h4 style="margin:0">${d.name}</h4>
                    <p style="font-size:13px; opacity:0.7">Class: ${d.class} | Parent: ${d.parent || d.father}</p>
                    <button style="width:100%; font-size:12px" onclick='generatePDF(${JSON.stringify({...d, id:id})}, "STUDENT_PROFILE")'>Download Profile PDF</button>
                </div>`;
            } else resDiv.innerHTML = "<p style='color:red'>Student Not Found</p>";
        } else {
            const doc = await db.collection("results").doc(id).get();
            if(doc.exists) {
                const exams = doc.data().exams;
                let html = "<h4>Available Exams</h4>";
                for(let key in exams) {
                    html += `<button style="width:100%; margin-bottom:8px; background:#334155; text-align:left" 
                             onclick='downloadResult("${id}", "${key}")'>üìÑ ${key}</button>`;
                }
                resDiv.innerHTML = html;
            } else resDiv.innerHTML = "<p style='color:red'>No results found</p>";
        }
    }

    // --- Professional Result PDF ---
    async function downloadResult(sid, examId) {
        const sDoc = await db.collection("students").doc(sid).get();
        const rDoc = await db.collection("results").doc(sid).get();
        const s = sDoc.data();
        const examData = rDoc.data().exams[examId];

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(139,0,0); doc.rect(0,0,210,40,'F');
        doc.setTextColor(255); doc.setFontSize(22); doc.text("ACADEMIX PROGRESS REPORT", 105, 25, null,null,"center");
        doc.setTextColor(0); doc.setFontSize(12);
        doc.text(`Student: ${s.name}`, 20, 50);
        doc.text(`Enrollment ID: ${sid}`, 20, 57);
        doc.text(`Examination: ${examId}`, 150, 50);

        const rows = Object.entries(examData.subjects).map(([sub, marks]) => [sub, marks, "100"]);
        doc.autoTable({
            startY: 65,
            head: [['Subject', 'Marks Obtained', 'Max Marks']],
            body: rows,
            theme: 'grid',
            headStyles: {fillColor: [139,0,0]}
        });
        doc.save(`${s.name}_${examId}.pdf`);
    }

    // --- Admission Stream ---
    db.collection("new_requests").onSnapshot(snap => {
        let html = "";
        document.getElementById("countLabel").innerText = snap.size + " NEW";
        snap.forEach(doc => {
            const d = doc.data();
            html += `
            <div class="req-card">
                <div><b>${d.name}</b><br><small>Class: ${d.class}</small></div>
                <div style="display:flex; gap:5px">
                    <button style="background:#10b981" onclick="approveAdmission('${doc.id}', '${d.name}')">Accept</button>
                    <button style="background:#ef4444" onclick="deleteReq('${doc.id}')">‚úñ</button>
                </div>
            </div>`;
        });
        document.getElementById("requestList").innerHTML = html || "<p style='opacity:0.5'>No pending requests</p>";
    });

    async function approveAdmission(reqId, name) {
        const snap = await db.collection("students").get();
        let max = 0; snap.forEach(s => { if(parseInt(s.id) > max) max = parseInt(s.id); });
        const nextID = (max + 1).toString().padStart(4, '0');

        document.getElementById("modalContent").innerHTML = `
            <h3>Enroll Student</h3>
            <p>Assigning ID to <b>${name}</b></p>
            <input id="finalID" value="${nextID}" style="text-align:center; font-size:24px; font-weight:bold; color:var(--accent)">
            <button onclick="finalize('${reqId}')" style="width:100%">Issue Enrollment</button>
            <button onclick="closeModal()" style="background:none; color:white; width:100%; margin-top:10px">Cancel</button>`;
        document.getElementById("systemModal").classList.add("active");
    }

    async function finalize(reqId) {
        const newID = document.getElementById("finalID").value;
        const snap = await db.collection("new_requests").doc(reqId).get();
        await db.collection("students").doc(newID).set({...snap.data(), id: newID});
        await db.collection("new_requests").doc(reqId).delete();
        alert("Enrolled successfully!"); closeModal();
    }

    // --- Admin Update ---
    async function triggerUpdate() {
        const keyCheck = prompt("Security Check: Enter Security Key");
        const adminDoc = await db.collection("admins").doc(activeId).get();
        
        if(keyCheck === adminDoc.data().key) {
            const nName = document.getElementById("up_name").value || activeName;
            const nKey = document.getElementById("up_key").value || adminDoc.data().key;
            await db.collection("admins").doc(activeId).update({ name: nName, key: nKey });
            localStorage.setItem("activeAdminName", nName);
            alert("Settings Updated!"); location.reload();
        } else {
            alert("Incorrect Security Key!");
        }
    }

    function generatePDF(data, title) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 20, 20);
        doc.autoTable({ startY: 30, body: Object.entries(data) });
        doc.save(`${data.name}.pdf`);
    }

    function closeModal() { document.getElementById("systemModal").classList.remove("active"); }
    function logout() { localStorage.clear(); window.location.href = "login.html"; }
    async function deleteReq(id) {
        if(confirm("Confirm Reject?")) {
            const key = prompt("Enter Key:");
            const admin = await db.collection("admins").doc(activeId).get();
            if(key === admin.data().key) await db.collection("new_requests").doc(id).delete();
            else alert("Wrong Key!");
        }
    }
</script>
</body>
</html>
